<!DOCTYPE html>
<html">
<head>
  <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
  <!-- ******* Load vonageClientSDK from a CDN ****** -->
  <script src="https://cdn.jsdelivr.net/npm/@vonage/client-sdk@latest/dist/vonageClientSDK.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        spacing: {
          '1': '8px',
          '2': '12px'
        }
      }
    }
  </script>
  <script type="text/javascript">
    const client = new vonageClientSDK.VonageClient();
    let phone = '';
    let btnCall;
    let btnHangup;
    let currentCall;
    let operatorName = 'Operator';  // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼å

    // ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã¨ã
    window.onload = async () => {
      btnCall = document.getElementById('btnCall');
      btnHangup = document.getElementById('btnHangup');

      console.log(`ðŸž Get query parameters`)
      try {
        // ã‚¯ã‚¨ãƒªãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
        let params = new URLSearchParams(decodeURI(location.search))
        params.forEach((value, key) => {
          if (key === 'number') {
          // phoneã®å…ˆé ­ãŒ0ã®å ´åˆã¯ã€81ã«å¤‰æ›
            phone = value.startsWith('0') ? '81' + value.slice(1) : value;
          }
        })
        console.log(`ðŸž ${phone}`);
      } catch (error) {
        console.error(`ðŸž Error: ${error.message}`)                  
      }
    }

    async function phoneCall() {
      try {
        btnCall.disabled = true;
        btnCall.innerHTML = 'æº–å‚™ä¸­...';
        // JWTã®å–å¾—
        const response = await fetch(`./getToken?name=${operatorName}`);
        const data = await response.json();
        const jwt = data.jwt;
        initSDK(jwt);
      } catch (error) {
        btnCall.disabled = false;
        btnCall.innerHTML = 'ç™ºä¿¡';
        console.error(`ðŸž Error: ${error.message}`)        
      }
    }

		async function hangup() {
      try {
        btnHangup.disabled = true;
        btnHangup.innerHTML = 'åˆ‡æ–­ä¸­...';
        client.hangup(currentCall).then(() => {
          console.log('Call ended');
          btnCall.hidden = false;
          btnHangup.hidden = true;
          btnHangup.disabled = false;
        }).catch((error) => {
          throw error;
        });
      } catch (error) {
        btnHangup.disabled = false;
        btnHangup.innerHTML = 'åˆ‡æ–­';
        btnHangup.hidden = false;
        console.error(`ðŸž Error: ${error.message}`)        
      }
    }

    function initSDK(jwt) {
      // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ
      client.createSession(jwt).then(sessionId => {
        console.log("ðŸž Connected");

        // ã‚³ãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('legStatusUpdate', (callId, legId, status) => {
          console.log(`ðŸž Leg status update: ${status}`);
          if (status === 'RINGING') { // å‘¼ã³å‡ºã—ä¸­
            btnCall.hidden = true;
            btnHangup.innerHTML = 'å‘¼ã³å‡ºã—ä¸­...';
            btnHangup.hidden = false;
          }
          if (status === 'ANSWERED') {  // ç›¸æ‰‹ãŒå¿œç­”ã—ãŸ
            btnHangup.innerHTML = 'åˆ‡æ–­';
          }
          if (status === 'COMPLETED') { // é€šè©±ãŒçµ‚äº†
            btnCall.disabled = false;
            btnCall.innerHTML = 'ç™ºä¿¡';
            btnCall.hidden = false;
            btnHangup.hidden = true;
            btnHangup.innerHTML = 'åˆ‡æ–­';
          }
        });

        // é€šè©±ãŒåˆ‡æ–­ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('callHangup', (callId, callQuality, reason) => {
          console.log('ðŸž Call ended');
          btnCall.disabled = false;
          btnCall.innerHTML = 'ç™ºä¿¡';
          btnCall.hidden = false;
          btnHangup.hidden = true;
          btnHangup.innerHTML = 'åˆ‡æ–­';
        });

        // é›»è©±ç•ªå·ã‚’æŒ‡å®šã—ã¦ç™ºä¿¡
        client.serverCall({ to: phone }).then((callId) => {
          console.log('ðŸž Calling ...');
          btnCall.innerHTML = 'ç™ºä¿¡ä¸­...';
          currentCall = callId;
        }).catch((error) => {
          throw error;
        });
      }).catch((error) =>{
          btnCall.disabled = false;
          btnCall.innerHTML = 'ç™ºä¿¡';
          console.log(error);
      });
    }

    </script>
</head>
<body class="center">
  <div class="m-0">
  	<button id="btnCall" class="text-white font-bold bg-blue-400 p-2 rounded" onclick="phoneCall()">ç™ºä¿¡</button>
  	<button id="btnHangup" class="text-white font-bold bg-red-400 p-2 rounded" hidden onclick="hangup()">åˆ‡æ–­</button>
  </div>
</body>
</html>
