<!DOCTYPE html>
<html">
<head>
  <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
  <!-- ******* Load vonageClientSDK from a CDN ****** -->
  <script src="https://cdn.jsdelivr.net/npm/@vonage/client-sdk@latest/dist/vonageClientSDK.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        spacing: {
          '1': '8px',
          '2': '12px'
        }
      }
    }
  </script>
  <script type="text/javascript">
    let phone = '';
    let btnCall;
    let btnHangup;
    let currentCall;
    let userId = '';  // ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼ID
    const client = new vonageClientSDK.VonageClient();
    const ringtone = new Audio('./ringtone.mp3'); // ç€ä¿¡éŸ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®š
      
    // ãƒšãƒ¼ã‚¸ã®ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ãŸã¨ã
    window.onload = async () => {
      btnCall = document.getElementById('btnCall');
      btnInvite = document.getElementById('btnInvite');
      btnHangup = document.getElementById('btnHangup');
      
      try {
        // ã‚¯ã‚¨ãƒªãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆOperatorIdï¼‰ã‚’å–å¾—
        console.log(`ğŸ Get query parameters`)
        let params = new URLSearchParams(decodeURI(location.search))
        params.forEach((value, key) => {
          if (key === 'userId') {
            userId = value;
          }
          if (key === 'phone') {
            // valueã®å…ˆé ­ï¼‘æ–‡å­—ãŒã€Œ0ã€ã®å ´åˆã¯'+81'ã«å¤‰æ›
            phone = value.charAt(0) === '0' ? '+81' + value.slice(1) : value;
            btnCall.disabled = false;
            btnCall.innerHTML = 'ç™ºä¿¡';
            btnCall.hidden = false;
          }
        })
        if (userId === '') {
          throw new Error('userId is not set.');
        }
        console.log(`ğŸ userId: ${userId} phone: ${phone}`);

        // JWTã®å–å¾—
        const response = await fetch(`./getToken?name=${userId}`);
        const data = await response.json();
        const jwt = data.jwt;
  
        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®ä½œæˆ
        client.createSession(jwt)
          .then(sessionId => {
            console.log("ğŸ Session created.");
          }).catch(error => {
            throw error;
          });

        // ã‚³ãƒ¼ãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('legStatusUpdate', (callId, legId, status) => {
          console.log(`ğŸ Leg status update: ${status}`);
          if (status === 'RINGING') { // å‘¼ã³å‡ºã—ä¸­
            btnCall.hidden = true;
            btnHangup.innerHTML = 'å‘¼ã³å‡ºã—ä¸­...';
            btnHangup.hidden = false;
          }
          if (status === 'ANSWERED') {  // ç›¸æ‰‹ãŒå¿œç­”ã—ãŸ
            btnHangup.innerHTML = 'åˆ‡æ–­';
          }
          if (status === 'COMPLETED') { // é€šè©±ãŒçµ‚äº†
            if (phone) {
              btnCall.disabled = false;
              btnCall.innerHTML = 'ç™ºä¿¡';
              btnCall.hidden = false;
            }
            btnHangup.hidden = true;
            btnHangup.innerHTML = 'åˆ‡æ–­';
          }
        });

        // é€šè©±ãŒåˆ‡æ–­ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('callHangup', (callId, callQuality, reason) => {
          console.log('ğŸ Call ended');
          if (phone) {
            btnCall.disabled = false;
            btnCall.innerHTML = 'ç™ºä¿¡';
            btnCall.hidden = false;
          }
          btnHangup.hidden = true;
          btnHangup.innerHTML = 'åˆ‡æ–­';
        });

        // ç€ä¿¡ã—ãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('callInvite', (callId) => {
          console.log(`ğŸ Incoming call.`)
          currentCall = callId;
          btnCall.disabled = true;
          btnCall.hidden = true;
          btnInvite.disabled = false;
          btnInvite.hidden = false;
          ringtone.loop = true; // ãƒ«ãƒ¼ãƒ—å†ç”Ÿ   
          ringtone.play();  // ç€ä¿¡éŸ³ã‚’å†ç”Ÿ
        });

        // ç€ä¿¡ãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸã¨ãã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        client.on('callInviteCancel', (callId) => {
          console.log(`ğŸ Call invite canceled.`)
          ringtone.pause();  // ç€ä¿¡éŸ³ã‚’åœæ­¢
          ringtone.currentTime = 0; // å†ç”Ÿä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
          if (phone) {
            btnCall.disabled = false;
            btnCall.innerHTML = 'ç™ºä¿¡';
            btnCall.hidden = false;
          }
          btnInvite.hidden = true;
        });
        
      } catch (error) {
        console.error(`ğŸ Error: ${error.message}`)                  
      }
    }

    async function phoneCall() {
      try {
        btnCall.disabled = true;
        btnCall.innerHTML = 'æº–å‚™ä¸­...';

        // é›»è©±ç•ªå·ã‚’æŒ‡å®šã—ã¦ç™ºä¿¡
        client.serverCall({ to: phone }).then((callId) => {
          console.log('ğŸ Calling ...');
          btnCall.innerHTML = 'ç™ºä¿¡ä¸­...';
          currentCall = callId;
        }).catch((error) => {
          throw error;
        });

      } catch (error) {
        btnCall.disabled = false;
        btnCall.innerHTML = 'ç™ºä¿¡';
        console.error(`ğŸ Error: ${error.message}`)        
      }
    }

		async function invite() {
      try {
        btnInvite.disabled = true;
        ringtone.pause();  // ç€ä¿¡éŸ³ã‚’åœæ­¢
        ringtone.currentTime = 0; // å†ç”Ÿä½ç½®ã‚’ãƒªã‚»ãƒƒãƒˆ
        client.answer(currentCall).then(() => {
          console.log('Call answered');
          btnInvite.hidden = true;
          btnHangup.hidden = false;
          btnHangup.disabled = false;
        }).catch((error) => {
          throw error;
        });
      } catch (error) {
        btnInvite.disabled = false;
        btnInvite.hidden = true;
        console.error(`ğŸ Error: ${error.message}`)        
      }
    }

		async function hangup() {
      try {
        btnHangup.disabled = true;
        btnHangup.innerHTML = 'åˆ‡æ–­ä¸­...';
        client.hangup(currentCall).then(() => {
          console.log('Call ended');
          if (phone) {
            btnCall.disabled = false;
            btnCall.innerHTML = 'ç™ºä¿¡';
            btnCall.hidden = false;
          }
          btnHangup.hidden = true;
          btnHangup.disabled = false;
        }).catch((error) => {
          throw error;
        });
      } catch (error) {
        btnHangup.disabled = false;
        btnHangup.innerHTML = 'åˆ‡æ–­';
        btnHangup.hidden = false;
        console.error(`ğŸ Error: ${error.message}`)        
      }
    }
  </script>
</head>
<body class="center">
  <div class="m-0">
  	<button id="btnCall" class="text-white font-bold bg-blue-400 p-2 rounded" hidden onclick="phoneCall()">ç™ºä¿¡</button>
  	<button id="btnInvite" class="text-white font-bold bg-red-400 p-2 rounded" hidden onclick="invite()">ç€ä¿¡ä¸­...</button>
  	<button id="btnHangup" class="text-white font-bold bg-red-400 p-2 rounded" hidden onclick="hangup()">åˆ‡æ–­</button>
  </div>
</body>
</html>
